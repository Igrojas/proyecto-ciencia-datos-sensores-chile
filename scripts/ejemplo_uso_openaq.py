#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Ejemplos de uso del Extractor de OpenAQ
======================================

Este archivo contiene varios ejemplos pr√°cticos de c√≥mo usar
el extractor de datos de calidad del aire de OpenAQ.
"""
#%%
from openaq_extractor import OpenAQExtractor
from datetime import datetime, timedelta
import pandas as pd


def ejemplo_basico():
    """
    Ejemplo b√°sico: obtener datos de PM2.5 de Madrid en la √∫ltima semana
    """
    print("=== Ejemplo 1: Datos de Madrid ===")
    
    # Inicializar (reemplaza con tu API key)
    api_key = "91eab8b4c15ab8e5eda9712fa803abe4bb45e5a6c8ee961d295de18b0b15722a"
    extractor = OpenAQExtractor(api_key)
    
    # Fechas
    fecha_fin = datetime.now().strftime('%Y-%m-%d')
    fecha_inicio = (datetime.now() - timedelta(days=7)).strftime('%Y-%m-%d')
    
    # Obtener datos
    datos = extractor.get_measurements(
        country='ES',
        city='Madrid',
        parameter='pm25',
        date_from=fecha_inicio,
        date_to=fecha_fin,
        limit=1000
    )
    
    if not datos.empty:
        print(f"‚úÖ Obtenidos {len(datos)} registros de PM2.5 en Madrid")
        extractor.save_to_csv(datos, 'madrid_pm25.csv')
        
        # Mostrar estad√≠sticas b√°sicas
        print(f"Valor promedio: {datos['value'].mean():.2f} ¬µg/m¬≥")
        print(f"Valor m√°ximo: {datos['value'].max():.2f} ¬µg/m¬≥")
        print(f"Valor m√≠nimo: {datos['value'].min():.2f} ¬µg/m¬≥")
    else:
        print("‚ùå No se encontraron datos")


def ejemplo_multiples_ciudades():
    """
    Ejemplo: obtener datos de m√∫ltiples ciudades espa√±olas
    """
    print("\n=== Ejemplo 2: M√∫ltiples ciudades espa√±olas ===")
    
    api_key = "91eab8b4c15ab8e5eda9712fa803abe4bb45e5a6c8ee961d295de18b0b15722a"
    extractor = OpenAQExtractor(api_key)
    
    ciudades = ['Madrid', 'Barcelona', 'Valencia', 'Sevilla']
    fecha_fin = datetime.now().strftime('%Y-%m-%d')
    fecha_inicio = (datetime.now() - timedelta(days=3)).strftime('%Y-%m-%d')
    
    datos_consolidados = []
    
    for ciudad in ciudades:
        print(f"Obteniendo datos de {ciudad}...")
        
        datos = extractor.get_measurements(
            country='ES',
            city=ciudad,
            parameter=['pm25', 'pm10'],
            date_from=fecha_inicio,
            date_to=fecha_fin,
            limit=500
        )
        
        if not datos.empty:
            datos_consolidados.append(datos)
            print(f"  ‚úÖ {len(datos)} registros de {ciudad}")
        else:
            print(f"  ‚ùå Sin datos de {ciudad}")
    
    if datos_consolidados:
        # Consolidar todos los datos
        df_final = pd.concat(datos_consolidados, ignore_index=True)
        extractor.save_to_csv(df_final, 'ciudades_espanolas.csv')
        
        # Resumen por ciudad
        resumen = df_final.groupby(['city', 'parameter'])['value'].agg(['count', 'mean', 'std'])
        print("\nResumen por ciudad:")
        print(resumen)


def ejemplo_pais_completo():
    """
    Ejemplo: an√°lisis de un pa√≠s completo
    """
    print("\n=== Ejemplo 3: An√°lisis de M√©xico ===")
    
    api_key = "91eab8b4c15ab8e5eda9712fa803abe4bb45e5a6c8ee961d295de18b0b15722a"
    extractor = OpenAQExtractor(api_key)
    
    # Obtener ciudades disponibles en M√©xico
    print("Obteniendo ciudades disponibles en M√©xico...")
    ciudades = extractor.get_cities(country_code='MX')
    print(f"Ciudades encontradas: {len(ciudades)}")
    
    for ciudad in ciudades[:5]:  # Mostrar solo las primeras 5
        print(f"  - {ciudad.get('city', 'N/A')} ({ciudad.get('count', 0)} mediciones)")
    
    # Obtener datos recientes de M√©xico
    fecha_fin = datetime.now().strftime('%Y-%m-%d')
    fecha_inicio = (datetime.now() - timedelta(days=5)).strftime('%Y-%m-%d')
    
    datos_mexico = extractor.get_measurements(
        country='MX',
        parameter=['pm25', 'o3'],
        date_from=fecha_inicio,
        date_to=fecha_fin,
        limit=2000,
        max_pages=5
    )
    
    if not datos_mexico.empty:
        extractor.save_to_csv(datos_mexico, 'mexico_calidad_aire.csv')
        
        # An√°lisis por ciudad
        analisis_ciudades = datos_mexico.groupby('city')['value'].agg(['count', 'mean'])
        analisis_ciudades = analisis_ciudades.sort_values('count', ascending=False)
        
        print(f"\nTop 10 ciudades con m√°s mediciones:")
        print(analisis_ciudades.head(10))


def ejemplo_contaminantes_especificos():
    """
    Ejemplo: an√°lisis de contaminantes espec√≠ficos
    """
    print("\n=== Ejemplo 4: An√°lisis de contaminantes ===")
    
    api_key = "91eab8b4c15ab8e5eda9712fa803abe4bb45e5a6c8ee961d295de18b0b15722a"
    extractor = OpenAQExtractor(api_key)
    
    # Obtener todos los par√°metros disponibles
    parametros = extractor.get_parameters()
    print("Par√°metros disponibles:")
    for param in parametros:
        print(f"  - {param.get('displayName', 'N/A')} ({param.get('id', 'N/A')})")
    
    # An√°lisis de m√∫ltiples contaminantes en una ciudad
    fecha_fin = datetime.now().strftime('%Y-%m-%d')
    fecha_inicio = (datetime.now() - timedelta(days=10)).strftime('%Y-%m-%d')
    
    contaminantes = ['pm25', 'pm10', 'o3', 'no2', 'so2', 'co']
    
    datos_completos = extractor.get_measurements(
        country='US',
        city='Los Angeles',
        parameter=contaminantes,
        date_from=fecha_inicio,
        date_to=fecha_fin,
        limit=1500
    )
    
    if not datos_completos.empty:
        extractor.save_to_csv(datos_completos, 'los_angeles_todos_contaminantes.csv')
        
        # Crear tabla pivot para an√°lisis
        tabla_pivot = datos_completos.pivot_table(
            values='value',
            index='fecha',
            columns='parameter',
            aggfunc='mean'
        )
        
        print("\nPromedios diarios por contaminante:")
        print(tabla_pivot.head())
        
        # Guardar tabla pivot
        tabla_pivot.to_csv('los_angeles_promedios_diarios.csv')


def ejemplo_exportar_excel():
    """
    Ejemplo: exportar datos a Excel con m√∫ltiples hojas
    """
    print("\n=== Ejemplo 5: Exportar a Excel ===")
    
    api_key = "91eab8b4c15ab8e5eda9712fa803abe4bb45e5a6c8ee961d295de18b0b15722a"
    extractor = OpenAQExtractor(api_key)
    
    fecha_fin = datetime.now().strftime('%Y-%m-%d')
    fecha_inicio = (datetime.now() - timedelta(days=7)).strftime('%Y-%m-%d')
    
    # Obtener datos de diferentes pa√≠ses
    paises = ['ES', 'FR', 'IT']
    
    with pd.ExcelWriter('calidad_aire_europa.xlsx', engine='openpyxl') as writer:
        for pais in paises:
            print(f"Procesando {pais}...")
            
            datos = extractor.get_measurements(
                country=pais,
                parameter='pm25',
                date_from=fecha_inicio,
                date_to=fecha_fin,
                limit=1000
            )
            
            if not datos.empty:
                # Guardar en hoja separada
                datos.to_excel(writer, sheet_name=pais, index=False)
                print(f"  ‚úÖ {len(datos)} registros guardados en hoja '{pais}'")
            else:
                print(f"  ‚ùå Sin datos para {pais}")
    
    print("Archivo Excel creado: calidad_aire_europa.xlsx")


def ejemplo_santiago_chile():
    """
    Ejemplo espec√≠fico: obtener datos completos de Santiago de Chile
    """
    print("=== Extrayendo datos de Santiago de Chile ===")
    
    # API key configurada
    api_key = "91eab8b4c15ab8e5eda9712fa803abe4bb45e5a6c8ee961d295de18b0b15722a"
    extractor = OpenAQExtractor(api_key)
    
    # Primero, exploremos qu√© datos est√°n disponibles para Chile
    print("1. Explorando ciudades disponibles en Chile...")
    ciudades_chile = extractor.get_cities(country_code='CL')
    print(f"   Ciudades encontradas en Chile: {len(ciudades_chile)}")
    
    # Mostrar todas las ciudades disponibles
    for ciudad in ciudades_chile:
        print(f"   - {ciudad.get('city', 'N/A')} ({ciudad.get('count', 0)} mediciones)")
    
    # Obtener par√°metros disponibles
    print("\n2. Verificando par√°metros disponibles...")
    parametros = extractor.get_parameters()
    parametros_disponibles = [p['id'] for p in parametros[:10]]
    print(f"   Par√°metros principales: {', '.join(parametros_disponibles)}")
    
    # Fechas para an√°lisis (√∫ltimo mes)
    fecha_fin = datetime.now().strftime('%Y-%m-%d')
    fecha_inicio = (datetime.now() - timedelta(days=30)).strftime('%Y-%m-%d')
    
    print(f"\n3. Obteniendo datos de Santiago desde {fecha_inicio} hasta {fecha_fin}...")
    
    # Intentar obtener datos de Santiago con varios par√°metros
    contaminantes = ['pm25', 'pm10', 'o3', 'no2', 'so2', 'co']
    
    datos_santiago = extractor.get_measurements(
        country='CL',
        city='Santiago',
        parameter=contaminantes,
        date_from=fecha_inicio,
        date_to=fecha_fin,
        limit=5000,
        max_pages=10
    )
    
    if not datos_santiago.empty:
        print(f"‚úÖ ¬°√âxito! Obtenidos {len(datos_santiago)} registros de Santiago")
        
        # Guardar datos principales
        extractor.save_to_csv(datos_santiago, 'santiago_chile_calidad_aire.csv')
        
        # An√°lisis detallado
        resumen = extractor.get_data_summary(datos_santiago)
        print(f"\nüìä Resumen de datos:")
        print(f"   - Per√≠odo: {resumen['fechas']['fecha_inicio']} a {resumen['fechas']['fecha_fin']}")
        print(f"   - Ubicaciones: {len(resumen['ubicaciones'])} estaciones")
        print(f"   - Contaminantes encontrados: {', '.join(resumen['parametros'])}")
        
        # Estad√≠sticas por contaminante
        print(f"\nüìà Estad√≠sticas por contaminante:")
        for param, stats in resumen['estadisticas_por_parametro'].items():
            print(f"   {param.upper()}:")
            print(f"     - Promedio: {stats['mean']:.2f}")
            print(f"     - M√°ximo: {stats['max']:.2f}")
            print(f"     - M√≠nimo: {stats['min']:.2f}")
            print(f"     - Registros: {stats['count']}")
        
        # An√°lisis por ubicaci√≥n
        print(f"\nüó∫Ô∏è  An√°lisis por ubicaci√≥n:")
        analisis_ubicaciones = datos_santiago.groupby('location')['value'].agg(['count', 'mean'])
        analisis_ubicaciones = analisis_ubicaciones.sort_values('count', ascending=False)
        print(analisis_ubicaciones.head(10))
        
        # Crear tabla pivot por d√≠as
        if 'fecha' in datos_santiago.columns:
            tabla_diaria = datos_santiago.pivot_table(
                values='value',
                index='fecha',
                columns='parameter',
                aggfunc='mean'
            )
            tabla_diaria.to_csv('santiago_promedios_diarios.csv')
            print(f"\nüìÖ Promedios diarios guardados en 'santiago_promedios_diarios.csv'")
            print("√öltimos 5 d√≠as:")
            print(tabla_diaria.tail())
    
    else:
        print("‚ùå No se encontraron datos para Santiago")
        
        # Intentar b√∫squeda m√°s amplia en Chile
        print("\nüîç Intentando b√∫squeda m√°s amplia en Chile...")
        datos_chile = extractor.get_measurements(
            country='CL',
            parameter=['pm25', 'pm10'],
            date_from=fecha_inicio,
            date_to=fecha_fin,
            limit=3000,
            max_pages=5
        )
        
        if not datos_chile.empty:
            print(f"‚úÖ Encontrados {len(datos_chile)} registros en Chile")
            extractor.save_to_csv(datos_chile, 'chile_calidad_aire.csv')
            
            # Mostrar ciudades con datos
            ciudades_con_datos = datos_chile['city'].value_counts()
            print("\nCiudades con datos disponibles:")
            print(ciudades_con_datos.head(10))


def main():
    """
    Ejecutar todos los ejemplos
    """
    print("üåç Ejemplos de uso del Extractor de OpenAQ\n")
    
    # Ejecutar ejemplo de Santiago de Chile
    ejemplo_santiago_chile()
    
    print("\nüìö Otros ejemplos disponibles:")
    print("- ejemplo_basico() - Datos de Madrid")
    print("- ejemplo_multiples_ciudades() - Varias ciudades espa√±olas")
    print("- ejemplo_pais_completo() - An√°lisis de M√©xico")
    print("- ejemplo_contaminantes_especificos() - An√°lisis detallado")
    print("- ejemplo_exportar_excel() - Exportar a Excel")


if __name__ == "__main__":
    main()

# %%
# Extracci√≥n espec√≠fica de datos para 2 ciudades de Chile
def extraer_datos_dos_ciudades_chile():
    """
    Extrae datos de calidad del aire de 2 ciudades principales de Chile
    """
    print("üá®üá± === EXTRACCI√ìN DE DATOS DE 2 CIUDADES DE CHILE ===\n")
    
    # Configurar API
    api_key = "91eab8b4c15ab8e5eda9712fa803abe4bb45e5a6c8ee961d295de18b0b15722a"
    extractor = OpenAQExtractor(api_key)
    
    # Explorar ciudades disponibles en Chile
    print("1Ô∏è‚É£ Explorando ciudades disponibles en Chile...")
    ciudades_chile = extractor.get_cities(country_code='CL')
    print(f"   üìç Total ciudades encontradas: {len(ciudades_chile)}\n")
    
    # Mostrar todas las ciudades disponibles con sus conteos
    print("   Ciudades disponibles:")
    for i, ciudad in enumerate(ciudades_chile, 1):
        ciudad_nombre = ciudad.get('city', 'N/A')
        mediciones = ciudad.get('count', 0)
        print(f"   {i:2d}. {ciudad_nombre:20} - {mediciones:,} mediciones")
    
    # Seleccionar las 2 ciudades con m√°s datos
    if len(ciudades_chile) >= 2:
        # Ordenar por n√∫mero de mediciones y tomar las 2 primeras
        ciudades_ordenadas = sorted(ciudades_chile, key=lambda x: x.get('count', 0), reverse=True)
        ciudad1 = ciudades_ordenadas[0]['city']
        ciudad2 = ciudades_ordenadas[1]['city']
    else:
        # Ciudades predeterminadas si no hay suficientes datos
        ciudad1 = 'Santiago'
        ciudad2 = 'Valpara√≠so'
    
    print(f"\n2Ô∏è‚É£ Ciudades seleccionadas para an√°lisis:")
    print(f"   üèôÔ∏è Ciudad 1: {ciudad1}")
    print(f"   üèôÔ∏è Ciudad 2: {ciudad2}")
    
    # Configurar fechas (√∫ltimos 2 meses para obtener m√°s datos)
    fecha_fin = datetime.now().strftime('%Y-%m-%d')
    fecha_inicio = (datetime.now() - timedelta(days=60)).strftime('%Y-%m-%d')
    
    print(f"\n3Ô∏è‚É£ Per√≠odo de an√°lisis: {fecha_inicio} a {fecha_fin}")
    
    # Contaminantes principales a buscar
    contaminantes = ['pm25', 'pm10', 'o3', 'no2', 'so2', 'co']
    print(f"   üß™ Contaminantes: {', '.join(contaminantes)}")
    
    # Extraer datos para cada ciudad
    datos_ciudades = {}
    
    for i, ciudad in enumerate([ciudad1, ciudad2], 1):
        print(f"\n{i+2}Ô∏è‚É£ Extrayendo datos de {ciudad}...")
        
        datos = extractor.get_measurements(
            country='CL',
            city=ciudad,
            parameter=contaminantes,
            date_from=fecha_inicio,
            date_to=fecha_fin,
            limit=10000,
            max_pages=15
        )
        
        if not datos.empty:
            print(f"   ‚úÖ {len(datos):,} registros obtenidos de {ciudad}")
            datos_ciudades[ciudad] = datos
            
            # Guardar datos individuales
            filename = f"{ciudad.lower().replace(' ', '_')}_chile_calidad_aire.csv"
            extractor.save_to_csv(datos, filename)
            print(f"   üíæ Datos guardados en: {filename}")
            
            # Estad√≠sticas r√°pidas
            contaminantes_encontrados = datos['parameter'].unique()
            ubicaciones = datos['location'].nunique()
            print(f"   üìä Contaminantes encontrados: {', '.join(contaminantes_encontrados)}")
            print(f"   üìç Estaciones de medici√≥n: {ubicaciones}")
            
        else:
            print(f"   ‚ùå No se encontraron datos para {ciudad}")
    
    # An√°lisis comparativo si tenemos datos de ambas ciudades
    if len(datos_ciudades) >= 2:
        print(f"\n6Ô∏è‚É£ === AN√ÅLISIS COMPARATIVO ===")
        
        # Combinar datos de ambas ciudades
        todos_los_datos = []
        for ciudad, datos in datos_ciudades.items():
            todos_los_datos.append(datos)
        
        df_combinado = pd.concat(todos_los_datos, ignore_index=True)
        
        # Guardar datos combinados
        extractor.save_to_csv(df_combinado, 'chile_dos_ciudades_combinado.csv')
        print(f"   üíæ Datos combinados guardados en: chile_dos_ciudades_combinado.csv")
        
        # An√°lisis por ciudad
        print(f"\n   üìà Resumen por ciudad:")
        resumen_ciudades = df_combinado.groupby('city').agg({
            'value': ['count', 'mean', 'min', 'max', 'std'],
            'parameter': 'nunique',
            'location': 'nunique'
        }).round(2)
        print(resumen_ciudades)
        
        # An√°lisis por contaminante
        print(f"\n   üß™ An√°lisis por contaminante:")
        for parametro in df_combinado['parameter'].unique():
            datos_param = df_combinado[df_combinado['parameter'] == parametro]
            if not datos_param.empty:
                print(f"\n   {parametro.upper()}:")
                stats_param = datos_param.groupby('city')['value'].agg(['count', 'mean', 'min', 'max']).round(2)
                print(stats_param)
        
        # Crear tabla pivot para comparaci√≥n
        tabla_comparativa = df_combinado.pivot_table(
            values='value',
            index='city',
            columns='parameter',
            aggfunc=['mean', 'count']
        ).round(2)
        
        # Guardar tabla comparativa
        tabla_comparativa.to_csv('chile_comparacion_ciudades.csv')
        print(f"\n   üíæ Tabla comparativa guardada en: chile_comparacion_ciudades.csv")
        
        # An√°lisis temporal si hay datos suficientes
        if 'fecha' in df_combinado.columns:
            tendencias_diarias = df_combinado.groupby(['fecha', 'city', 'parameter'])['value'].mean().reset_index()
            tendencias_pivot = tendencias_diarias.pivot_table(
                values='value',
                index=['fecha', 'parameter'],
                columns='city',
                aggfunc='mean'
            )
            tendencias_pivot.to_csv('chile_tendencias_diarias.csv')
            print(f"   üìÖ Tendencias diarias guardadas en: chile_tendencias_diarias.csv")
    
    print(f"\n‚úÖ === EXTRACCI√ìN COMPLETADA ===")
    print(f"üìÇ Archivos generados:")
    print(f"   ‚Ä¢ Datos individuales por ciudad")
    print(f"   ‚Ä¢ Datos combinados de ambas ciudades")
    print(f"   ‚Ä¢ Tabla comparativa entre ciudades")
    print(f"   ‚Ä¢ Tendencias diarias (si hay datos suficientes)")
    
    return datos_ciudades

# Ejecutar la extracci√≥n
if __name__ == "__main__":
    resultado = extraer_datos_dos_ciudades_chile()

# %%
